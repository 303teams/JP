<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.bjtu.dao.HomeworkDao">

    <update id="setAnswer">
        Update homework
        Set answer = #{answer},Afilename = #{Afilename}
        Where homeworkID = #{homeworkID}
    </update>

    <select id="findAll" resultType="Homework">
        select * from homework
    </select>

    <select id="findHWById" resultType="Homework">
        SELECT *
        FROM homework
        WHERE homework.homeworkID = #{id}
    </select>

    <select id="findHWbyCno" resultType="com.bjtu.pojo.Homework">
        SELECT DISTINCT homework.*,
                        teacher.name as teacherName,
                        course.cname as courseName ,
                        content.contentID as contentID
        FROM student
                 JOIN sc ON student.id = sc.sno
                 JOIN homework ON sc.cno = homework.cno
                 JOIN teacher ON homework.tno = teacher.id
                 JOIN course ON homework.cno = course.cno
                 LEFT JOIN content ON homework.homeworkID = content.homeworkID
            AND content.cno = course.cno
            AND content.sno = student.id
        WHERE student.id = #{id} and course.cno = #{cno}
    </select>
    <select id="findHWsbyCno" resultType="com.bjtu.pojo.Homework">
        SELECT
            H.*,
            COUNT(DISTINCT sc.sno) AS totalAmount,
            COUNT(DISTINCT C.sno) AS submitAmount
        FROM
            homework H
                JOIN sc ON H.cno = sc.cno
                LEFT JOIN content C ON H.homeworkID = C.homeworkID AND sc.sno = C.sno
        WHERE
            H.cno = #{cno}
        GROUP BY
            H.homeworkID, H.content, H.cno;

    </select>

    <insert id="insert" parameterType="Homework" useGeneratedKeys="true" keyProperty="homeworkID">
        insert into homework(homeworkID,cno,name,content,tno,fileName,submitDdl,scoreDdl)
        values (#{homeworkID}, #{cno},#{name},#{content},#{tno},#{fileName},#{submitDdl},#{scoreDdl})
    </insert>



</mapper>